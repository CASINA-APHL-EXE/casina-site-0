<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>AUDIO — CASINA</title>
  <style>
    :root{--c:rgba(0,255,255,.85);--b:rgba(0,255,255,.08);}
    html,body{margin:0;height:100%;background:#000;font-family:monospace;overflow:hidden;}
    body{opacity:1;transition:opacity .6s ease, filter .6s ease;}
    body.is-entering{opacity:0;filter:blur(2px);}
    html.is-transitioning body{opacity:0;filter:blur(2px);}

    #viz{position:fixed;inset:0;z-index:0;}
    .hud{position:fixed;top:18px;left:18px;z-index:2;color:var(--c);opacity:.78;letter-spacing:3px;user-select:none;}
    .hud .sub{opacity:.55;letter-spacing:2px;font-size:12px;margin-top:6px}
    .nav{position:fixed;top:18px;right:18px;z-index:2;display:flex;gap:10px;}
    .btn{color:var(--c);text-decoration:none;border:1px solid rgba(0,255,255,.25);background:rgba(0,255,255,.06);
      padding:10px 12px;border-radius:14px;letter-spacing:2px;font-size:12px;opacity:.85;}
    .btn:hover{opacity:1}

    .panel{
      position:fixed;left:50%;top:56%;transform:translate(-50%,-50%);
      width:min(820px,92vw);z-index:2;
      border:1px solid rgba(0,255,255,.18);
      background: radial-gradient(700px 260px at 50% 30%, rgba(0,255,255,.10), transparent 60%), rgba(0,255,255,.04);
      border-radius:22px;
      padding:18px;
      box-shadow:0 0 60px rgba(0,255,255,.10);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .title{color:var(--c);letter-spacing:3px;opacity:.85}
    .pill{border:1px solid rgba(0,255,255,.18);background:rgba(0,0,0,.25);color:var(--c);
      padding:8px 10px;border-radius:999px;letter-spacing:2px;font-size:11px;opacity:.75}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      cursor:pointer;
      border:1px solid rgba(0,255,255,.25);
      background:rgba(0,255,255,.06);
      color:var(--c);
      padding:10px 12px;border-radius:14px;
      letter-spacing:2px;font-family:monospace;
      opacity:.85;
      transition:transform .2s ease, opacity .2s ease;
    }
    button:hover{opacity:1;transform:translateY(-1px)}
    input[type="range"]{accent-color:cyan;width:220px}
    .note{margin-top:14px;color:var(--c);opacity:.45;letter-spacing:2px;font-size:12px;line-height:1.4}
    footer{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);color:var(--c);opacity:.28;letter-spacing:3px;user-select:none;pointer-events:none;}
  </style>
</head>
<body>
  <canvas id="viz"></canvas>

  <div class="hud">
    AUDIO // REACTOR ONLINE
    <div class="sub">web-audio prototype · replace with your tracks later</div>
  </div>

  <div class="nav">
    <a class="btn" href="/">← HOME</a>
  </div>

  <div class="panel">
    <div class="row">
      <div class="title">SIGNAL GENERATOR</div>
      <div class="pill" id="state">STATE: IDLE</div>
    </div>

    <div class="controls">
      <button id="toggle">START</button>
      <button id="mode">MODE: PULSE</button>

      <label class="pill">VOLUME
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.15"/>
      </label>

      <label class="pill">FREQ
        <input id="freq" type="range" min="40" max="1800" step="1" value="160"/>
      </label>
    </div>

    <div class="note">
      This is a placeholder “sonic module”.<br/>
      Later: swap oscillator → load your mp3/wav, analyze FFT, drive visuals.
    </div>
  </div>

  <footer>audio field active · awaiting input</footer>

  <script>
    // transitions + bfcache
    document.body.classList.add("is-entering");
    requestAnimationFrame(()=>requestAnimationFrame(()=>document.body.classList.remove("is-entering")));
    window.addEventListener("pageshow", () => {
      document.documentElement.classList.remove("is-transitioning");
      document.body.classList.remove("is-entering");
    });

    document.querySelectorAll('a[href="/"]').forEach(a=>{
      a.addEventListener("click",(e)=>{
        e.preventDefault();
        document.documentElement.classList.add("is-transitioning");
        setTimeout(()=>location.href="/", 520);
      });
    });

    // WebAudio mini reactor
    let ctx=null, osc=null, gain=null, analyser=null, data=null;
    let running=false, pulse=true;
    const stateEl=document.getElementById("state");
    const toggleBtn=document.getElementById("toggle");
    const modeBtn=document.getElementById("mode");
    const vol=document.getElementById("vol");
    const freq=document.getElementById("freq");

    function setState(s){ stateEl.textContent = "STATE: " + s; }

    function ensureAudio(){
      if(ctx) return;
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = ctx.createAnalyser();
      analyser.fftSize = 1024;
      data = new Uint8Array(analyser.frequencyBinCount);

      gain = ctx.createGain();
      gain.gain.value = parseFloat(vol.value);

      osc = ctx.createOscillator();
      osc.type = "sawtooth";
      osc.frequency.value = parseFloat(freq.value);

      osc.connect(gain);
      gain.connect(analyser);
      analyser.connect(ctx.destination);

      osc.start();
    }

    toggleBtn.onclick = async () => {
      if(!running){
        ensureAudio();
        if(ctx.state === "suspended") await ctx.resume();
        gain.gain.value = parseFloat(vol.value);
        running=true;
        toggleBtn.textContent="STOP";
        setState("RUNNING");
      }else{
        // soft stop: set volume to 0
        gain.gain.value = 0;
        running=false;
        toggleBtn.textContent="START";
        setState("IDLE");
      }
    };

    modeBtn.onclick = () => {
      pulse = !pulse;
      modeBtn.textContent = "MODE: " + (pulse ? "PULSE" : "FLOW");
    };

    vol.oninput = () => { if(gain) gain.gain.value = running ? parseFloat(vol.value) : 0; };
    freq.oninput = () => { if(osc) osc.frequency.value = parseFloat(freq.value); };

    // Visualizer
    const canvas = document.getElementById("viz");
    const g = canvas.getContext("2d");
    let W=0,H=0,DPR=1;
    function resize(){
      DPR=Math.min(2, devicePixelRatio||1);
      W=innerWidth; H=innerHeight;
      canvas.width=Math.floor(W*DPR);
      canvas.height=Math.floor(H*DPR);
      canvas.style.width=W+"px"; canvas.style.height=H+"px";
      g.setTransform(DPR,0,0,DPR,0,0);
    }
    addEventListener("resize", resize); resize();

    let t=0;
    function draw(){
      t+=0.016;
      g.fillStyle="rgba(0,0,0,0.25)";
      g.fillRect(0,0,W,H);

      let level=0;
      if(analyser && running){
        analyser.getByteFrequencyData(data);
        // average low-mid bins
        let sum=0, n=Math.min(64, data.length);
        for(let i=0;i<n;i++) sum += data[i];
        level = (sum/n)/255;
      }

      const cx=W/2, cy=H/2;
      const rings = 9;
      for(let i=0;i<rings;i++){
        const r = 60 + i*38 + (pulse ? Math.sin(t*2 + i*0.8)*10 : i*0.0) + level*90;
        const a = 0.10 + (rings-i)*0.012 + level*0.18;
        g.strokeStyle = `rgba(0,255,255,${a})`;
        g.lineWidth = 2;
        g.beginPath();
        g.arc(cx,cy,r,0,Math.PI*2);
        g.stroke();
      }

      // waveform-ish bars
      const bars=80;
      for(let i=0;i<bars;i++){
        const x = (i/(bars-1))*W;
        const h = (Math.sin(t*1.3 + i*0.25)*0.5+0.5) * (22 + level*180);
        const a = 0.05 + level*0.25;
        g.fillStyle = `rgba(0,255,255,${a})`;
        g.fillRect(x, H-50-h, 2, h);
      }

      requestAnimationFrame(draw);
    }
    draw();
  </script>
</body>
</html>